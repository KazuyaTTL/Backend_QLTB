const axios = require('axios');

const BASE_URL = 'http://localhost:3000/api';

async function testAtlasAPI() {
  console.log('üß™ Testing API with Atlas Database\n');
  
  try {
    // Test 1: Health check
    console.log('1Ô∏è‚É£ Testing health endpoint...');
    const health = await axios.get(`${BASE_URL}/health`);
    console.log('‚úÖ Health check:', health.data.message);
    
    // Test 2: Get equipment list
    console.log('\n2Ô∏è‚É£ Testing equipment list...');
    const equipment = await axios.get(`${BASE_URL}/equipment`);
    console.log(`‚úÖ Equipment loaded: ${equipment.data.length} items`);
    
    // Test 3: Login admin
    console.log('\n3Ô∏è‚É£ Testing admin login...');
    const login = await axios.post(`${BASE_URL}/auth/login`, {
      email: 'admin@quanlythietbi.edu.vn',
      password: 'Admin123@'
    });
    console.log('‚úÖ Admin login successful');
    const token = login.data.token;
    
    // Test 4: Get profile with token
    console.log('\n4Ô∏è‚É£ Testing authenticated profile...');
    const profile = await axios.get(`${BASE_URL}/auth/profile`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log(`‚úÖ Profile loaded: ${profile.data.name} (${profile.data.role})`);
    
    // Test 5: Get borrow requests
    console.log('\n5Ô∏è‚É£ Testing borrow requests...');
    const borrowRequests = await axios.get(`${BASE_URL}/borrow-requests`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log(`‚úÖ Borrow requests loaded: ${borrowRequests.data.length} requests`);
    
    console.log('\nüéâ ‚úÖ T·∫•t c·∫£ API tests th√†nh c√¥ng v·ªõi Atlas!');
    console.log('üìù Server ƒëang ch·∫°y t·ªët v·ªõi database cloud');
    
  } catch (error) {
    console.error('‚ùå API Test Failed:');
    
    if (error.code === 'ECONNREFUSED') {
      console.log('üí° Server ch∆∞a kh·ªüi ƒë·ªông ho·∫∑c port 3000 b·ªã chi·∫øm');
      console.log('   - Ch·∫°y: npm start');
      console.log('   - Ho·∫∑c ki·ªÉm tra port kh√°c');
    } else if (error.response) {
      console.log(`üìç HTTP ${error.response.status}: ${error.response.data.message || error.response.data}`);
    } else {
      console.log(`üîç Error: ${error.message}`);
    }
    
    process.exit(1);
  }
}

testAtlasAPI(); 