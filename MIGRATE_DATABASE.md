# üîÑ Migrate MongoDB Local ‚Üí Atlas (An to√†n)

## ‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG

**KH√îNG X√ìA** MongoDB local cho ƒë·∫øn khi Atlas ho·∫°t ƒë·ªông 100% OK!

## üìã Plan Migration (Kh√¥ng m·∫•t d·ªØ li·ªáu)

### B∆∞·ªõc 1: Backup d·ªØ li·ªáu hi·ªán t·∫°i (5 ph√∫t)

```bash
# T·∫°o th∆∞ m·ª•c backup
mkdir database-backup

# Export t·∫•t c·∫£ collections
mongodump --db equipment-management --out database-backup/

# Ki·ªÉm tra backup th√†nh c√¥ng
ls database-backup/equipment-management/
# Ph·∫£i th·∫•y: users.bson, equipment.bson, borrowrequests.bson, etc.
```

### B∆∞·ªõc 2: Setup MongoDB Atlas (10 ph√∫t)

1. **T·∫°o account:** [mongodb.com/cloud/atlas](https://mongodb.com/cloud/atlas)
2. **Create cluster:** Ch·ªçn FREE tier (M0 Sandbox - 512MB)
3. **Cluster name:** `equipment-management-cluster`
4. **Provider:** AWS/Google (g·∫ßn Vi·ªát Nam nh·∫•t)

### B∆∞·ªõc 3: C·∫•u h√¨nh Access (3 ph√∫t)

**Database Access:**
- Username: `equipment_admin`
- Password: T·∫°o password m·∫°nh (l∆∞u l·∫°i!)
- Role: `Atlas admin`

**Network Access:**
- Add IP: `0.0.0.0/0` (Allow all)
- Comment: "Allow all IPs for deployment"

### B∆∞·ªõc 4: Get Connection String (2 ph√∫t)

1. Click **"Connect"** ‚Üí **"Connect your application"**
2. Copy connection string:
   ```
   mongodb+srv://tatienloc11:Cdkcmkvl123.@my-backend-cluster.4gmo3bj.mongodb.net/?retryWrites=true&w=majority&appName=my-backend-cluster
   ```
3. Thay `<password>` b·∫±ng password th·∫≠t

### B∆∞·ªõc 5: Test Connection Local ‚Üí Atlas (5 ph√∫t)

T·∫°o file test connection:
```javascript
// testAtlas.js
const mongoose = require('mongoose');

const ATLAS_URI = 'mongodb+srv://tatienloc11:Cdkcmkvl123.@my-backend-cluster.4gmo3bj.mongodb.net/?retryWrites=true&w=majority&appName=my-backend-cluster';

async function testConnection() {
  try {
    await mongoose.connect(ATLAS_URI);
    console.log('‚úÖ Atlas connection successful!');
    
    // Test t·∫°o collection
    const testCollection = mongoose.connection.db.collection('test');
    await testCollection.insertOne({ test: 'success', date: new Date() });
    console.log('‚úÖ Write test successful!');
    
    await mongoose.disconnect();
    console.log('‚úÖ All tests passed!');
  } catch (error) {
    console.error('‚ùå Connection failed:', error.message);
  }
}

testConnection();
```

Ch·∫°y test:
```bash
node testAtlas.js
```

### B∆∞·ªõc 6: Migrate Data v·ªõi MongoDB Tools (10 ph√∫t)

**Option A: D√πng MongoDB Compass (GUI - D·ªÖ h∆°n)**

1. T·∫£i [MongoDB Compass](https://www.mongodb.com/products/compass)
2. K·∫øt n·ªëi local: `mongodb://localhost:27017`
3. K·∫øt n·ªëi Atlas: Connection string t·ª´ b∆∞·ªõc 4
4. Copy paste t·ª´ng collection local ‚Üí Atlas

**Option B: D√πng Command Line**

```bash
# Restore backup v√†o Atlas
mongorestore --uri="mongodb+srv://tatienloc11:Cdkcmkvl123.@my-backend-cluster.4gmo3bj.mongodb.net/?retryWrites=true&w=majority&appName=my-backend-cluster" database-backup/equipment-management/
```

### B∆∞·ªõc 7: Verify Data Migration (5 ph√∫t)

T·∫°o script ki·ªÉm tra:
```javascript
// verifyMigration.js
const mongoose = require('mongoose');

const LOCAL_URI = 'mongodb://localhost:27017/equipment-management';
const ATLAS_URI = 'mongodb+srv://tatienloc11:Cdkcmkvl123.@my-backend-cluster.4gmo3bj.mongodb.net/?retryWrites=true&w=majority&appName=my-backend-cluster';

async function compareData() {
  // Connect to local
  const localConn = await mongoose.createConnection(LOCAL_URI);
  
  // Connect to Atlas  
  const atlasConn = await mongoose.createConnection(ATLAS_URI);
  
  const collections = ['users', 'equipment', 'borrowrequests'];
  
  for (const collName of collections) {
    const localCount = await localConn.db.collection(collName).countDocuments();
    const atlasCount = await atlasConn.db.collection(collName).countDocuments();
    
    console.log(`üìä ${collName}:`);
    console.log(`   Local: ${localCount} documents`);
    console.log(`   Atlas: ${atlasCount} documents`);
    console.log(`   ‚úÖ Match: ${localCount === atlasCount ? 'YES' : 'NO'}`);
  }
  
  await localConn.close();
  await atlasConn.close();
}

compareData();
```

### B∆∞·ªõc 8: Update Backend Config (1 ph√∫t)

**CH·ªà SAU KHI VERIFY OK**, c·∫≠p nh·∫≠t `.env`:

```bash
# Comment local database
# MONGODB_URI=mongodb://localhost:27017/equipment-management

# Use Atlas
MONGODB_URI=mongodb+srv://tatienloc11:Cdkcmkvl123.@my-backend-cluster.4gmo3bj.mongodb.net/?retryWrites=true&w=majority&appName=my-backend-cluster
```

### B∆∞·ªõc 9: Test Backend v·ªõi Atlas (5 ph√∫t)

```bash
# Restart server
npm run dev

# Test API
curl http://localhost:5000/health
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@quanlythietbi.edu.vn","password":"Admin123@"}'
```

## ‚úÖ Checklist Migration

- [ ] Backup local database th√†nh c√¥ng
- [ ] Atlas cluster ƒë√£ t·∫°o
- [ ] Connection string test OK
- [ ] Data migrate ho√†n t·∫•t
- [ ] Verify data counts match
- [ ] Backend test v·ªõi Atlas OK
- [ ] Admin login th√†nh c√¥ng

## üö® Rollback Plan (N·∫øu c√≥ l·ªói)

**N·∫øu Atlas c√≥ v·∫•n ƒë·ªÅ:**
1. ƒê·ªïi l·∫°i `.env` v·ªÅ local:
   ```bash
   MONGODB_URI=mongodb://localhost:27017/equipment-management
   ```
2. Restart server
3. M·ªçi th·ª© v·ªÅ nh∆∞ c≈©!

## üí° Pro Tips

1. **Gi·ªØ local database** cho ƒë·∫øn khi deploy production ho√†n t·∫•t
2. **Test k·ªπ tr√™n Atlas** tr∆∞·ªõc khi deploy
3. **Backup ƒë·ªãnh k·ª≥:** Atlas c√≥ auto-backup nh∆∞ng n√™n export th·ªß c√¥ng
4. **Monitor performance:** Atlas free tier c√≥ limit
5. **Connection pooling:** Atlas t·ª± ƒë·ªông handle

## üîç Troubleshooting

**L·ªói Connection Timeout:**
- Ki·ªÉm tra Network Access whitelist
- Th·ª≠ IP kh√°c: current IP + 0.0.0.0/0

**L·ªói Authentication:**
- Check username/password
- ƒê·∫£m b·∫£o user c√≥ quy·ªÅn ƒë√∫ng database

**Slow Performance:**
- Atlas free tier c√≥ gi·ªõi h·∫°n
- Optimize queries n·∫øu c·∫ßn 